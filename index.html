<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reparador de enlaces</title>
    <link rel="stylesheet" href="./node_modules/materialize-css/dist/css/materialize.css">
    <script src="./node_modules/materialize-css/dist/js/materialize.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" defer></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

</head>
<style>
    .visualizer h1{
        font-size: 24pt;
    }

    .code, .preview{
        display: none;
    }

    .active{
        display: block;
    }
</style>
<body>
    <div class="container">
        <div class="row">
            <div class="col s12">
                <h3>Reparador de enlaces</h3>
                <hr>
                <br>
                <a id="new-button" class="blue darken-4 waves-effect waves-light btn" onclick="newRepair(event)"><i class="material-icons left">add_box</i>Nuevo</a>
                <a id="toggle-button" class="blue darken-4 waves-effect waves-light btn" data-toggle="preview" onclick="toggleView(this)"><i class="material-icons left">visibility</i>Previsualizar</a>
                <br>
            </div>
        </div>
        <div class="row">
            <div class="col s12">
                <label>
                    <input type="checkbox" id="listas" class="filled-in" />
                    <span>Sustituir listas por títulos</span>
                </label>
                &#160;&#160;
                <label>
                    <input type="checkbox" id="limpiar-obs" class="filled-in" />
                    <span>Limpiar OBS</span>
                </label>
            </div>  
        </div>
        <div class="row visualizer">
            <form class="col s6">
            <div class="row">
                <div class="input-field col s12 code active">
                <textarea id="entrada" onkeyup="fixAll(this.value)" class="materialize-textarea"></textarea>
                <label for="entrada">Introduce el texto a modificar</label>
                </div>
                <div class="col s12 preview">
                    <label for="">Texto fuente:</label>
                    <div id="source-preview">

                    </div>
                </div>
            </div>
            </form>
            <form class="col s6">
                <div class="row">
                <div class="input-field col s12 code active">
                    <textarea id="salida" class="materialize-textarea"></textarea>
                    <label for="salida">Resultado:</label>
                </div>
                <div class="col s12 preview">
                    <label for="">Resultado:</label>
                    <div id="result-preview">

                    </div>
                </div>
                </div>
            </form>
        </div>
    </div>
    <script>

        function newRepair(e){

            let button = document.getElementById('toggle-button')
            
            if(button.getAttribute('data-toggle') == 'code') toggleView(button);

            let resPreview = document.getElementById('result-preview')
            let srcPreview = document.getElementById('source-preview')
            resPreview.innerHTML = ''
            srcPreview.innerHTML = ''

            let salida = document.getElementById('salida')
            let entrada = document.getElementById('entrada')
            entrada.value = ''
            M.textareaAutoResize(entrada)
            salida.value = ''
            M.textareaAutoResize(salida)
            entrada.focus()
            M.updateTextFields()
        }

        function toggleView(button){
            if(button.getAttribute('data-toggle') == 'preview')
            {   
                button.innerHTML = '<i class="material-icons left">code</i>Ver código'
                button.setAttribute('data-toggle', 'code')
            }
            else
            {
                button.innerHTML = '<i class="material-icons left">visibility</i>Previsualizar'
                button.setAttribute('data-toggle', 'preview')
            }

            let code = document.querySelectorAll(".code")
                code.forEach((element)=>{
                    element.classList.toggle("active")
                })

            let preview = document.querySelectorAll(".preview")
                preview.forEach((element)=>{
                    element.classList.toggle("active")
                })            
        }
  
       async function fixAll(target){         

            let fixed = target

            let cleanObs = document.getElementById('limpiar-obs').checked
            let refactorLists = document.getElementById('listas').checked

            if(cleanObs) fixed = await cleanOBS(fixed)
            if(refactorLists) fixed = await refactorList(fixed)    

            fixed = await fixLinks(fixed)
            fixed = await fixTitles(fixed)
            fixed = await fixQuotes(fixed)
            fixed = await fixAsterisk(fixed)
            fixed = await cleanEdges(fixed)
                
            showResults(target,fixed);
        }

        function showResults(input, output){
            let salida = document.getElementById('salida')
            let resPreview = document.getElementById('result-preview')
            let srcPreview = document.getElementById('source-preview')
            salida.value = output  
            M.updateTextFields()
            M.textareaAutoResize(salida)
            salida.select();
            document.execCommand('copy')
            M.toast({html: 'Reultado Copiado'})
            srcPreview.innerHTML = marked(input)
            resPreview.innerHTML = marked(output)
        }

        function cleanLinks(target){
            let pattern = /(?:\[|(?:\\\[))+(?:rc:|https:|\.*)(?:.+)(?:\]|\\\])*\]/g
            let fixed = target.replace(pattern, (match)=>{
                return match.replace(/\s+/g, '')
            })
            console.log(fixed)
            return fixed
        }

        function fixLinks(target){
            let pattern = /(?: ?\([^\)\s]+[ :]?(?:\[|(?:\\\[))+((?:rc:|https:|\.*)?\/\/?(?:[\w-_\.]+\/)*((?:[A-Za-z-_]+(?:\d+)?))(?:\/[0-9]+)?(?:\.\w+)?\/?)\/?(?:\]|\\\])*(?:\)|\])*[^\n \.])|(?:\[|(?:\\\[))+((?:rc:|https:|\.*)?\/\/?(?:[\w-_\.]+\/)*((?:[A-Za-z-_]+(?:\d+)?))(?:\/[0-9]+)?(?:\.\w+)?\/?)(?:\]|(?:\\\]))*/gm
            
            let fixed = cleanLinks(target)
                fixed = fixed.replace(pattern, (match, p1, p2, p3, p4)=>{
                
                let path = ''
                let slug = ''

                if(p1){
                    path = p1;
                    slug = p2
                } 

                if(p3){
                    path = p3
                    slug = p4
                }

                let tituloPartes = slug.split('-')
                tituloPartes = tituloPartes.map((string) => string[0].toUpperCase() + string.slice(1))
                let titulo = tituloPartes.join(' ')
                let enlace = '['+titulo+']'+'('+path+')'
                return ` (ver: ${enlace})`
            })
            return fixed
        }

        function fixAsterisk(target){
            let pattern = /(?:(?:\\\*|\*){2}(?: )*([^\n\*\\]+)(?: )*(?:\\\*|\*){2})/gm
            let fixed = target.replace(pattern, (match, p1, p2)=> p1 ? `**${p1}**` : `**${p2}**`)
            return fixed
        }

        function cleanQuotes(target){
            let pattern = /(“|”)|(‘|’)/gm
            let fixed = target.replace(pattern, (match, p1, p2)=> p1 ? `"` : `'`)
            return fixed
        }

        function fixQuotes(target){

            let pattern = /"([^"]+)"|'([^"']+)'/gm

            let fixed = cleanQuotes(target)
                fixed = fixed.replace(pattern, (match, p1, p2)=>{
                    
                    if(p1){
                        p1 = p1.replace(/'([^"']+)'/gm, (match, p) => {
                            return `‘${p}’`
                        })
                        console.log(`“${p1}”`)
                        return `“${p1}”`
                    }
                    
                    if(p2){
                        console.log(`‘${p2}’`)
                        return `‘${p2}’`
                    }
                })

            return fixed
        }

        function fixTitles(target){
            let pattern = /(?:^\s+)?#+(.+)\s+/gm
            let fixed = target.replace(pattern, (match, p)=>{   
                p = cleanEdges(p)
                return `\n# ${p}\n\n`
            })
            return fixed
        }

        function cleanEdges(target){
            let pattern = /^\s+|\s+$/g
            let fixed = target.replace(pattern, (match, p)=>{   
                return ''
            })
            return fixed
        }

        function refactorList(target){
            let pattern = /^(?: *\* *_* *([^_\*\n]*[^-]) *_*\s*-?\s+)(?!\*|#)(?:([^#\n]+)) *$/gm
            let fixed = target.replace(pattern, (match, p1, p2)=>{
                if(p1 && p2)
                    return `\n# ${cleanEdges(p1)}\n\n${cleanEdges(p2)}\n`

                return p1 ? `\n* ${cleanEdges(p1)}\n\n` : `\n* ${cleanEdges(p2)}\n\n`
            })
            return fixed
        }

        function cleanOBS(target){
            let pattern = /^(?:## .+ ##\n+[^#]+)*(?:#* *(?:Translation Notes|Notas de traducci[oó]n).+#*){1}\n+([^#]+)/gim
            let fixed = target.replace(pattern, (match, p) => {
                console.log(p)
                return p
            });
            return fixed
        }
    </script>
</body>
</html>